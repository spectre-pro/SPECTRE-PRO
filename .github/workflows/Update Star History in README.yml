# .github/workflows/update-star-history.yml
name: Update Star History in README

on:
  schedule:
    - cron: '0 0 * * *' # æ¯å¤© UTC æ™‚é–“åˆå¤œé‹è¡Œ
  push:
    branches: [ "main" ]
  workflow_dispatch: # å…è¨±æ‰‹å‹•è§¸ç™¼

permissions:
  contents: write # æˆäºˆå¯«å…¥å„²å­˜åº«å…§å®¹çš„æ¬Šé™

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch all repositories for spectre-pro # è«‹å°‡ spectre-pro æ›¿æ›ç‚ºæ‚¨çš„ GitHub ä½¿ç”¨è€…åç¨±
        id: get_repos
        run: |
          # é€™è£¡å‡è¨­æ‚¨çš„ä½¿ç”¨è€…åç¨±æ˜¯ spectre-pro
          repos=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/users/spectre-pro/repos?per_page=100&sort=pushed&direction=desc" | \
            jq -r '.[] | select(.fork == false and .archived == false) | .full_name' | \
            tr '\n' ',')
          echo "::set-output name=repos_list::${repos%,}" # ç§»é™¤æœ«å°¾çš„é€—è™Ÿ

      - name: Update Star History section in README.md
        run: |
          README_FILE="README.md"
          NEW_REPOS="${{ steps.get_repos.outputs.repos_list }}"
          
          # æª¢æŸ¥ NEW_REPOS æ˜¯å¦ç‚ºç©ºï¼Œä»¥é˜²æ­¢å‰µå»ºä¸æ­£ç¢ºçš„ URL
          if [ -z "$NEW_REPOS" ]; then
            echo "No repositories found. Exiting."
            exit 0
          fi

          # æ§‹å»ºåŸå§‹çš„ Star History URL
          RAW_STAR_HISTORY_URL_DARK="https://api.star-history.com/svg?repos=${NEW_REPOS}&type=Date&theme=dark"
          RAW_STAR_HISTORY_URL_LIGHT="https://api.star-history.com/svg?repos=${NEW_REPOS}&type=Date"

          # ä½¿ç”¨ perl é€²è¡Œå¤šè¡Œæ›¿æ›
          # `perl -i -0777 -pe` è¡¨ç¤ºï¼š
          #   -i: In-place edit (ç›´æ¥ä¿®æ”¹æ–‡ä»¶)
          #   -0777: Slurp mode (å°‡æ•´å€‹æ–‡ä»¶è®€å–ç‚ºå–®å€‹å­—ç¬¦ä¸²ï¼Œä»¥ä¾¿è™•ç†å¤šè¡ŒåŒ¹é…)
          #   -p: Loop through input, print lines (åœ¨æ¯æ¬¡å¾ªç’°å¾Œæ‰“å° $_ çš„å…§å®¹)
          #   -e: Execute command (åŸ·è¡Œå¾Œé¢çš„ Perl è…³æœ¬)
          # Perl çš„ `s///s` æ›¿æ›ï¼š
          #   - `s!` è¡¨ç¤ºä½¿ç”¨ `!` ä½œç‚ºåˆ†éš”ç¬¦ (è€Œä¸æ˜¯é è¨­çš„ `/`)ï¼Œé€™æ¨£ URL ä¸­çš„ `/` å°±ä¸éœ€è¦é¡å¤–è½‰ç¾©ã€‚
          #   - `<picture>.*?<\/picture>` åŒ¹é…å¾ `<picture>` é–‹å§‹åˆ°æœ€è¿‘çš„ `</picture>` çµæŸçš„æ‰€æœ‰å…§å®¹ã€‚
          #     - `.*?` æ˜¯éè²ªå©ªåŒ¹é…ï¼Œç¢ºä¿åªåŒ¹é…å–®å€‹ `<picture>` å€å¡Šã€‚
          #   - `s` ä¿®é£¾ç¬¦å…è¨± `.` åŒ¹é…æ–°è¡Œã€‚

          # åœ¨ Perl è…³æœ¬ä¸­ï¼Œéœ€è¦æ˜ç¢ºåœ°å°‡ shell è®Šé‡ä½œç‚ºç’°å¢ƒè®Šé‡å‚³éï¼Œä¸¦åœ¨ Perl ä¸­å¼•ç”¨ã€‚
          # æ­¤å¤–ï¼ŒPerl çš„æ›¿æ›å­—ç¬¦ä¸²ä¸­çš„ `&` ä¹Ÿæœ‰ç‰¹æ®Šå«ç¾©ï¼ˆè¡¨ç¤ºæ•´å€‹åŒ¹é…çš„å­—ç¬¦ä¸²ï¼‰ï¼Œéœ€è¦é¡å¤–è½‰ç¾©ã€‚
          # æˆ‘å€‘é€™è£¡è½‰ç¾© URL ä¸­å¯èƒ½å‡ºç¾çš„ `&` å’Œæ›¿æ›å®šç•Œç¬¦ `!`
          perl -i -0777 -pe '
            BEGIN {
              # å¾ç’°å¢ƒè®Šé‡ç²å– URL
              my $dark_url = $ENV{NEW_DARK_URL};
              my $light_url = $ENV{NEW_LIGHT_URL};

              # å° URL ä¸­çš„ç‰¹æ®Šå­—ç¬¦ (`&` å’Œæ›¿æ›å®šç•Œç¬¦ `!`) é€²è¡Œè½‰ç¾©ï¼Œ
              # ä»¥å…å®ƒå€‘åœ¨ Perl çš„æ›¿æ›å­—ç¬¦ä¸²ä¸­è¢«éŒ¯èª¤è§£é‡‹ã€‚
              $dark_url =~ s/([&!])/\\$1/g;
              $light_url =~ s/([&!])/\\$1/g;

              # æ§‹å»ºæ–°çš„ <picture> å€å¡Šå…§å®¹ã€‚æ³¨æ„é›™å¼•è™Ÿå’Œæ›è¡Œç¬¦ã€‚
              $new_picture_block = "<picture>\n <source media=\"(prefers-color-scheme: dark)\" srcset=\"$dark_url\" />\n <source media=\"(prefers-color-scheme: light)\" srcset=\"$light_url\" />\n <img alt=\"Star History Chart\" src=\"$light_url\" />\n</picture>";
            }
            # æŸ¥æ‰¾ä¸¦æ›¿æ›ç¾æœ‰çš„ <picture> å€å¡Š
            s!<picture>.*?<\/picture>!$new_picture_block!s;
          ' "$README_FILE"
        env: # å°‡ URL ä½œç‚ºç’°å¢ƒè®Šé‡å‚³éçµ¦ Perl è…³æœ¬
          NEW_DARK_URL: "$RAW_STAR_HISTORY_URL_DARK"
          NEW_LIGHT_URL: "$RAW_STAR_HISTORY_URL_LIGHT"
          
      - name: Commit changes
        run: |
          git diff --quiet || CHANGED=true
          if [ "$CHANGED" = true ]; then
            echo "README.md has been updated."
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add "$README_FILE"
            git commit -m "ğŸ¤– Update Star History for new repositories"
            git push
          else
            echo "No changes detected in README.md."
          fi
