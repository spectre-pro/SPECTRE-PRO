# .github/workflows/update-star-history.yml
name: Update Star History in README

on:
  schedule:
    - cron: '0 0 * * *' # æ¯å¤© UTC æ™‚é–“åˆå¤œé‹è¡Œ
  push:
    branches: [ "main" ]
  workflow_dispatch: # å…è¨±æ‰‹å‹•è§¸ç™¼

permissions:
  contents: write # æˆäºˆå¯«å…¥å„²å­˜åº«å…§å®¹çš„æ¬Šé™

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch all repositories for spectre-pro # è«‹å°‡ spectre-pro æ›¿æ›ç‚ºæ‚¨çš„ GitHub ä½¿ç”¨è€…åç¨±
        id: get_repos
        run: |
          repos=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/users/spectre-pro/repos?per_page=100&sort=pushed&direction=desc" | \
            jq -r '.[] | select(.fork == false and .archived == false) | .full_name' | \
            tr '\n' ',')
          echo "::set-output name=repos_list::${repos%,}" # ç§»é™¤æœ«å°¾çš„é€—è™Ÿ

      - name: Update Star History section in README.md
        run: |
          README_FILE="README.md"
          NEW_REPOS="${{ steps.get_repos.outputs.repos_list }}"
          
          if [ -z "$NEW_REPOS" ]; then
            echo "No repositories found. Exiting."
            exit 0
          fi

          # æ§‹å»ºåŸå§‹çš„ Star History URL
          RAW_STAR_HISTORY_URL_DARK="https://api.star-history.com/svg?repos=${NEW_REPOS}&type=Date&theme=dark"
          RAW_STAR_HISTORY_URL_LIGHT="https://api.star-history.com/svg?repos=${NEW_REPOS}&type=Date"

          # **æ–°ä¿®æ­£ï¼šå°‡è®Šæ•¸åŒ¯å‡ºç‚ºç’°å¢ƒè®Šæ•¸ï¼Œä»¥ä¾¿ Perl è…³æœ¬èƒ½å¤ è®€å–å…¶å€¼**
          export NEW_DARK_URL="$RAW_STAR_HISTORY_URL_DARK"
          export NEW_LIGHT_URL="$RAW_STAR_HISTORY_URL_LIGHT"

          # ä½¿ç”¨ perl é€²è¡Œå¤šè¡Œæ›¿æ›
          perl -i -0777 -pe '
            BEGIN {
              # å¾åŒ¯å‡ºçš„ç’°å¢ƒè®Šæ•¸ä¸­ç²å– URL å€¼
              my $dark_url = $ENV{NEW_DARK_URL};
              my $light_url = $ENV{NEW_LIGHT_URL};

              # å° URL ä¸­çš„ç‰¹æ®Šå­—ç¬¦ (`&` å’Œæ›¿æ›å®šç•Œç¬¦ `!`) é€²è¡Œè½‰ç¾©
              $dark_url =~ s/([&!])/\\$1/g;
              $light_url =~ s/([&!])/\\$1/g;

              # æ§‹å»ºæ–°çš„ <picture> å€å¡Šå…§å®¹ã€‚
              $new_picture_block = "<picture>\n <source media=\"(prefers-color-scheme: dark)\" srcset=\"$dark_url\" />\n <source media=\"(prefers-color-scheme: light)\" srcset=\"$light_url\" />\n <img alt=\"Star History Chart\" src=\"$light_url\" />\n</picture>";
            }
            # æŸ¥æ‰¾ä¸¦æ›¿æ›ç¾æœ‰çš„ <picture> å€å¡Š
            s!<picture>.*?<\/picture>!$new_picture_block!s;
          ' "$README_FILE"
          # é€™è£¡ç§»é™¤äº†åŸæœ¬çš„ 'env:' å€å¡Šï¼Œå› ç‚ºè®Šæ•¸å·²ç¶“åœ¨ run è…³æœ¬å…§éƒ¨åŒ¯å‡ºã€‚
          
      - name: Commit changes
        run: |
          README_FILE="README.md" # **é‡è¦ï¼šåœ¨æ­¤æ­¥é©Ÿç¯„åœå…§é‡æ–°å®šç¾© README_FILE**

          # ä½¿ç”¨ git diff æª¢æŸ¥ README.md æ˜¯å¦æœ‰è®ŠåŒ–
          if git diff --quiet "$README_FILE"; then
            echo "No changes detected in README.md."
          else
            echo "README.md has been updated. Committing changes."
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add "$README_FILE"
            git commit -m "ğŸ¤– Update Star History for new repositories"
            git push
          fi
